#!/usr/bin/env sh

__watsi_open () {
  open $SRC/watsi
}

__watsi_edit () {
  cd $SRC/watsi
  atom .
}

__watsi_start () {
  trap __watsi_kill INT TERM
  cd $SRC/watsi
  foreman start -f Procfile-development
}

__watsi_kill () {
  echo "Shutting down..."
  local smtp=$(lsof -ti tcp:1025)
  local mailcatcher=$(lsof -ti tcp:1080)
  local server=$(lsof -ti tcp:4000)
  local jasmine=$(lsof -ti tcp:8888)
  local sidekiq=$(lsof -ti tcp:6379)

  if [[ -n ${smtp} ]]; then
    kill -9 ${smtp}
  fi

  if [[ -n ${mailcatcher} ]]; then
    kill -9 ${mailcatcher}
  fi

  if [[ -n ${jasmine} ]]; then
    kill -9 ${jasmine}
  fi

  if [[ -n ${server} ]]; then
    kill -9 ${server}
  fi

  if [[ -n ${sidekiq} ]]; then
    kill -9 ${sidekiq}
  fi
}

__watsi_help () {
  echo -e ""
  echo -e "  Usage: watsi \e[2m[cmd] [args]\e[0m"
  echo -e ""
  echo "  Commands:"
  echo ""
  echo "    open      Open source folder in Finder"
  echo "    edit      Open source folder in editor"
  echo "    start     Start server"
  echo "    kill      Kill server"
  echo ""
}

# assert arguments
[ $# -ne 1 ] && __watsi_help && exit 1

# switch arguments
case $1 in
  o|open) __watsi_open;;
  e|edit) __watsi_edit;;
  s|start) __watsi_start;;
  k|kill) __watsi_kill;;
  -h|--help) __watsi_help;;
esac
